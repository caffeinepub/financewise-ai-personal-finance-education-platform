{
  "kind": "build_request",
  "title": "Implement Backend-First Data Persistence with Internet Identity Authentication",
  "projectName": "FinanceWise AI",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Implement Internet Identity authentication system that manages login/logout flow and persists authentication state across browser sessions",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "All private pages data must be saved in backend",
          "Each email/user must have unique data",
          "Data must remain after login, logout, refresh"
        ]
      },
      "acceptanceCriteria": [
        "Users can log in using Internet Identity (passkeys, Google, Apple, or Microsoft)",
        "Authentication state persists across browser refresh",
        "Logout clears frontend state but preserves all backend data",
        "Login redirects to Dashboard after successful authentication"
      ]
    },
    {
      "id": "REQ-2",
      "text": "Create backend data structure using HashMap to store user data keyed by Principal, with each user having isolated storage for transactions, goals, budgets, preferences, predictions, and quiz progress",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Use Principal → UserData",
          "Each Principal automatically gets separate storage",
          "Each user has completely isolated data"
        ]
      },
      "acceptanceCriteria": [
        "Backend uses HashMap<Principal, UserData> structure",
        "Each user's data is completely isolated by their Principal",
        "UserData includes all necessary fields: transactions, goals, budgets, preferences, predictions, quiz progress",
        "New users automatically get an empty UserData record on first login"
      ]
    },
    {
      "id": "REQ-3",
      "text": "Implement backend API endpoints for all CRUD operations on user data (transactions, goals, budgets, preferences, predictions, quiz progress) that save immediately to the HashMap and return updated data",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Frontend sends to backend API → Backend saves in database → Frontend refreshes data from backend",
          "ALWAYS save immediately to backend"
        ]
      },
      "acceptanceCriteria": [
        "All data mutations (create, update, delete) save to backend immediately",
        "API endpoints return updated data after successful operations",
        "Backend validates Principal identity for all operations",
        "Error handling returns clear messages for failed operations"
      ]
    },
    {
      "id": "REQ-4",
      "text": "Modify Dashboard page to fetch all data from backend on mount and after any mutation, never relying on frontend-only state for persistence",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Dashboard → backend saved",
          "Every page load/refresh → Fetch fresh data from backend",
          "NEVER store important data only in frontend state"
        ]
      },
      "acceptanceCriteria": [
        "Dashboard fetches user data from backend on component mount",
        "After adding/editing income or expenses, data refetches from backend",
        "Data persists after browser refresh",
        "Loading states display while fetching data"
      ]
    },
    {
      "id": "REQ-5",
      "text": "Modify Transactions page to fetch transaction history from backend and implement add/edit/delete operations that save immediately to backend",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Transactions → backend saved",
          "All CRUD operations go through backend API calls"
        ]
      },
      "acceptanceCriteria": [
        "Transactions page fetches all transactions from backend on mount",
        "Add transaction saves to backend and refetches data",
        "Edit transaction updates backend and refetches data",
        "Delete transaction removes from backend and refetches data",
        "All transaction data persists after logout and login"
      ]
    },
    {
      "id": "REQ-6",
      "text": "Modify Goals page to fetch savings goals from backend and implement CRUD operations with immediate backend persistence",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Goals → backend saved",
          "All data operations (add, edit, delete) will immediately save to backend"
        ]
      },
      "acceptanceCriteria": [
        "Goals page fetches all savings goals from backend on mount",
        "Creating new goals saves to backend immediately",
        "Updating goal progress saves to backend immediately",
        "Deleting goals removes from backend immediately",
        "Goal data persists across sessions"
      ]
    },
    {
      "id": "REQ-7",
      "text": "Modify Analytics page to fetch transaction data and user preferences from backend, ensuring all analytics calculations are based on backend data",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Analytics → backend saved",
          "fetch fresh data from backend"
        ]
      },
      "acceptanceCriteria": [
        "Analytics page fetches transaction data from backend on mount",
        "All charts and statistics calculate from backend data",
        "Adding transactions through Analytics form saves to backend",
        "Analytics preferences sync with backend user preferences",
        "Data remains available after logout/login cycle"
      ]
    },
    {
      "id": "REQ-8",
      "text": "Modify Budget Planner page to save budget plans to backend and fetch them on page load",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Budget, Planner → backend saved"
        ]
      },
      "acceptanceCriteria": [
        "Budget plans save to backend when generated",
        "Budget page fetches saved plans from backend on mount",
        "Budget data persists across sessions",
        "Users can view their previous budget plans after logout/login"
      ]
    },
    {
      "id": "REQ-9",
      "text": "Modify Calculators page to save calculation history to backend and fetch previous calculations on page load",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Calculators → backend saved"
        ]
      },
      "acceptanceCriteria": [
        "Calculator results save to backend after computation",
        "Calculators page shows calculation history from backend",
        "Calculation history persists across sessions",
        "Users can access previous calculations after logout/login"
      ]
    },
    {
      "id": "REQ-10",
      "text": "Modify AI Insights page to fetch AI predictions from backend and ensure prediction generation saves results to backend",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "AI Insights → backend saved",
          "All data operations will immediately save to backend"
        ]
      },
      "acceptanceCriteria": [
        "AI Insights page fetches predictions from backend on mount",
        "Generating new predictions saves results to backend",
        "Prediction data persists across sessions",
        "Users see their previous predictions after logout/login"
      ]
    },
    {
      "id": "REQ-11",
      "text": "Modify Quiz/Learning pages to save quiz progress and scores to backend keyed by user Principal",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Quiz → backend saved",
          "Data must remain after login, logout, refresh"
        ]
      },
      "acceptanceCriteria": [
        "Quiz progress saves to backend after each question",
        "Quiz completion scores save to backend",
        "Quiz page loads previous progress from backend",
        "Quiz history persists across sessions and devices"
      ]
    },
    {
      "id": "REQ-12",
      "text": "Implement Settings page backend integration to save user preferences (theme, notifications, analytics visibility, currency) to backend and fetch on page load",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "All private pages → backend saved",
          "Each user gets unique data storage"
        ]
      },
      "acceptanceCriteria": [
        "Settings changes save immediately to backend",
        "Settings page fetches preferences from backend on mount",
        "Theme preference persists across sessions",
        "Currency preference applies consistently across all pages",
        "Preferences sync across devices for the same user"
      ]
    },
    {
      "id": "REQ-13",
      "text": "Update all React Query hooks to invalidate and refetch data after mutations, ensuring frontend always displays current backend state",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Frontend refreshes data from backend",
          "Never save only in React state"
        ]
      },
      "acceptanceCriteria": [
        "All mutation hooks trigger query invalidation on success",
        "Data refetches automatically after create/update/delete operations",
        "Loading states display during refetch operations",
        "Error states handle failed refetch attempts"
      ]
    },
    {
      "id": "REQ-14",
      "text": "Implement comprehensive data persistence testing across all private pages to verify data survives browser refresh, logout/login cycles, and cross-device access",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Refresh browser → data still there",
          "Logout → Login → data still there",
          "Different device → Login → data loads"
        ]
      },
      "acceptanceCriteria": [
        "All private page data persists after browser refresh",
        "All private page data persists after logout and login",
        "Users can access their data from different browsers/devices",
        "No data loss occurs during authentication transitions",
        "Each user only sees their own isolated data"
      ]
    },
    {
      "id": "REQ-15",
      "text": "Update AppLayout logout handler to clear all frontend state and query cache while preserving backend data",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-recent"
        ],
        "quotes": [
          "Logout → Clear frontend state but preserve all backend data",
          "DO NOT delete backend data"
        ]
      },
      "acceptanceCriteria": [
        "Logout clears React Query cache",
        "Logout clears authentication state",
        "Logout does not trigger any backend delete operations",
        "Backend data remains intact after logout",
        "Next login successfully fetches all preserved data"
      ]
    }
  ],
  "constraints": [
    "Use single-actor Motoko architecture with all logic in backend/main.mo",
    "Use Principal as the unique identifier for user data, not email addresses",
    "Do not modify immutable frontend paths: hooks/useInternetIdentity.ts, hooks/useActor.ts, main.tsx, components/ui",
    "All data must persist in backend HashMap, never rely on localStorage for critical data",
    "Maintain existing Internet Identity integration in useInternetIdentity.ts hook",
    "Keep existing UI component library (Shadcn) usage intact"
  ],
  "nonGoals": [
    "Email-based authentication (Internet Identity only)",
    "Real-time synchronization or WebSocket connections",
    "Third-party authentication providers beyond Internet Identity",
    "Blockchain transaction recording beyond standard IC persistence",
    "Mobile app development or responsive design changes",
    "Performance optimizations beyond basic query invalidation",
    "Multi-language support or internationalization",
    "Admin dashboard or user management features"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}